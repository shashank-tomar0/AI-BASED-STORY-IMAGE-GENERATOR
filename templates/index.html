<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Canvas - AI Narrative Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:wght@400;600;700&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    
    <style>
        :root{
            --bg:#061219; /* deep navy */
            --panel:#081521; /* panel bg */
            --accent:#D4AF37; /* gold accent for premium feel */
            --accent-2:#FFD77A;
            --muted:#cdd6d1; /* soft off-white */
            --muted-2:#9fb7ad;
            --danger:#ff6b6b;
            --glass: rgba(255,255,255,0.03);
            --card-glow: 0 18px 60px rgba(212,175,55,0.06);
        }
        body { font-family: 'Inter', 'Space Mono', monospace; background: radial-gradient(1000px 500px at 10% 8%, rgba(212,175,55,0.03), transparent), linear-gradient(180deg,#031017 0%, #04121a 100%); color:var(--muted); }

        /* Card / panel base */
        .terminal-card{
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
            border: 1px solid rgba(255,255,255,0.02);
            box-shadow: var(--card-glow), 0 6px 26px rgba(0,0,0,0.6) inset;
            border-radius: 16px;
            padding: 1.25rem;
            transition: transform .18s ease, box-shadow .18s ease;
        }

        .terminal-input, .terminal-select, textarea.terminal-input{
            width:100%; padding:.75rem; background: rgba(255,255,255,0.02); border:1px solid rgba(0,255,136,0.06);
            color:var(--muted); border-radius:8px; outline:none; box-shadow: inset 0 1px 0 rgba(255,255,255,0.01);
        }

        .terminal-button{
            display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
            background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#081418; font-weight:600; border-radius:12px;
            padding:.7rem 1.05rem; border:none; cursor:pointer; box-shadow: 0 14px 40px rgba(0,0,0,0.6);
            transform: translateZ(0);
            letter-spacing: .2px;
        }

    .terminal-button-secondary{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03); padding:.5rem .9rem; border-radius:10px }

        .loading-spinner { border:4px solid rgba(0,255,136,0.08); border-top:4px solid var(--accent); border-radius:50%; width:20px; height:20px; animation:spin 1s linear infinite }
        @keyframes spin{ to{ transform:rotate(360deg) }}

    .scene-card{ border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,0.02); background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06)); box-shadow: 0 8px 30px rgba(0,0,0,0.6) }

    .scene-card:hover{ transform: translateY(-8px); box-shadow: 0 26px 80px rgba(0,0,0,0.6); }

    .prompt-label{ color:var(--accent-2); font-size:.88rem; display:block; margin-bottom:.4rem; font-weight:600 }

        /* Layout helpers */
    .layout-main{ display:grid; grid-template-columns: 380px 1fr; gap:1.25rem; align-items:start }
        .right-column{ display:flex; flex-direction:column; gap:1rem }
        .summary-card{ height:220px; overflow:auto }
    .storyboard{ display:grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap:1.25rem }

        /* Modals centered */
        #modal-container{ backdrop-filter: blur(3px) }
        #error-modal, #success-modal{ width:520px }
        .progress-box{ display:flex; align-items:center; gap:.6rem; padding:.5rem .75rem; background:rgba(0,0,0,0.25); border-radius:8px; color:var(--muted); border:1px solid rgba(0,255,136,0.04); }
    /* Keep important action buttons visible on long pages */
    .control-footer{ position:sticky; bottom:1rem; display:flex; gap:.6rem; align-items:center; background:transparent; padding-top:.5rem; z-index:20 }

    h1.site-title{ font-family: 'Playfair Display', 'Inter', serif; font-size:1.8rem; color:var(--accent); letter-spacing:.6px }
    </style>
</head>
<body class="bg-gray-900 text-green-400 min-h-screen">
    <div id="app" class="flex flex-col min-h-screen font-mono">
        <header class="p-4 sticky top-0 z-10" style="border-bottom:1px solid rgba(0,255,136,0.06)">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h1 style="color:var(--accent); font-size:1.6rem; font-weight:700">&gt; StoryCanvas_v4.0</h1>
                    <div style="color:var(--muted); opacity:.9">AI Narrative & Scene Generator</div>
                </div>
                    <div style="display:flex; align-items:center; gap:1rem">
                        <div id="provider-banner" style="color:var(--muted); font-size:.9rem; margin-right:0.5rem; padding:.35rem .6rem; background:rgba(255,255,255,0.02); border-radius:999px; border:1px solid rgba(255,255,255,0.02)"></div>
                        <!-- Modern toggle -->
                        <div style="display:flex; align-items:center; gap:.6rem;">
                            <label for="auto-gen-toggle" style="display:flex; align-items:center; gap:.6rem; cursor:pointer; user-select:none">
                                <div style="font-size:.85rem; color:var(--muted);">Auto-generate</div>
                                <div style="position:relative; width:46px; height:26px;">
                                    <input type="checkbox" id="auto-gen-toggle" style="opacity:0; width:46px; height:26px; position:absolute; left:0; top:0; cursor:pointer" />
                                    <div id="auto-gen-track" style="position:absolute; inset:0; background:rgba(255,255,255,0.04); border-radius:999px; border:1px solid rgba(255,255,255,0.03);"></div>
                                    <div id="auto-gen-thumb" style="position:absolute; left:4px; top:4px; width:18px; height:18px; background:linear-gradient(90deg,var(--accent),#2de6a8); border-radius:50%; box-shadow:0 6px 18px rgba(0,0,0,0.6); transition: left .18s ease;"></div>
                                </div>
                            </label>
                        </div>
                        <div id="auth-info" class="text-sm"></div>
                    </div>
            </div>
        </header>

        <main class="flex-grow p-6">
            <div class="layout-main">
                <aside>
                    <div id="auth-screen" class="terminal-card mb-4">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.6rem">
                            <h2 style="color:var(--accent); font-weight:700">User</h2>
                            <small style="color:var(--muted)">dev mode</small>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:.6rem">
                            <input type="text" id="auth-username" placeholder="Username" class="terminal-input">
                            <input type="password" id="auth-password" placeholder="Password" class="terminal-input">
                            <div style="display:flex; gap:.6rem">
                                <button id="login-btn" class="terminal-button" onclick="handleLogin()">Login</button>
                                <button id="register-btn" class="terminal-button-secondary" onclick="handleRegister()">Register</button>
                            </div>
                        </div>
                    </div>

                    <div id="story-controls" class="hidden terminal-card mb-4">
                        <h3 style="color:var(--accent); margin-bottom:.6rem">Story Generation</h3>
                        <div id="new-story-inputs" style="display:flex; flex-direction:column; gap:.6rem">
                            <textarea id="start-prompt" class="terminal-input" rows="5" placeholder="Enter your initial story idea or context (e.g., 'A rogue AI escapes its facility and tries to learn human emotion')."></textarea>
                            <label class="prompt-label">Select Visual Style</label>
                            <select id="art-style" class="terminal-select">
                                <option value="photorealistic cinematic">Photorealistic Cinematic</option>
                                <option value="cyberpunk painting">Cyberpunk Digital Painting</option>
                                <option value="watercolor illustration">Watercolor Illustration</option>
                                <option value="pencil sketch">Detailed Pencil Sketch</option>
                                <option value="voxel art">Voxel Art</option>
                            </select>
                            <div class="control-footer">
                                <button id="start-btn" class="terminal-button" onclick="handleInitialGeneration()">INITIATE STORY</button>
                                <button id="generate-from-idea-btn" class="terminal-button-secondary" title="Generate an image directly from your idea without using the LLM">IMAGE FROM IDEA</button>
                            </div>
                            <div class="control-footer" style="justify-content:flex-end; margin-top:.5rem">
                                <button id="continue-btn" class="terminal-button mt-2 hidden" onclick="handleStoryGeneration()">CONTINUE</button>
                            </div>
                        </div>
                    </div>

                    <div id="staging-area" class="hidden terminal-card" style="border:1px solid rgba(255,200,100,0.04);">
                        <h3 style="color:#ffd98a; margin-bottom:.6rem">Visual Staging</h3>
                        <div id="progress-steps" class="progress-box hidden" style="margin-bottom:.6rem">
                            <strong id="progress-step-label">1/2</strong>
                            <span id="progress-message">Preparing...</span>
                        </div>
                        <label class="prompt-label">Generated Narrative</label>
                        <p id="staging-narrative" style="background:rgba(255,255,255,0.02); padding:.6rem; border-radius:8px; color:var(--muted)"></p>
                        <label class="prompt-label" for="image-prompt-editor">Visual Prompt</label>
                        <textarea id="image-prompt-editor" class="terminal-input" rows="4"></textarea>
                        <div style="display:flex; gap:.6rem; margin-top:.6rem">
                            <button id="generate-image-btn" class="terminal-button" onclick="handleImageGeneration()">GENERATE IMAGE</button>
                            <button class="terminal-button-secondary" onclick="(function(){ stagingArea.classList.add('hidden'); storyControls.classList.remove('hidden'); })()">CANCEL</button>
                        </div>
                    </div>

                    <div id="loading-indicator" class="hidden terminal-card" style="display:flex; align-items:center; gap:.6rem">
                        <div class="loading-spinner"></div>
                        <span id="loading-message" style="color:var(--muted)">Processing...</span>
                    </div>
                </aside>

                <section class="right-column">
                    <div id="summary-output" class="terminal-card summary-card">
                        <h3 style="color:var(--accent); margin-bottom:.6rem">Narrative Log</h3>
                        <ul id="summary-list" style="list-style:none; padding-left:0; color:var(--muted);"></ul>
                    </div>

                    <div id="storyboard" class="storyboard">
                        <!-- Scenes will insert here -->
                    </div>
                </section>
            </div>
        </main>
        </main>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-gray-900/75 flex items-center justify-center z-50 hidden">
        <div id="error-modal" class="terminal-card bg-red-900/70 border-red-500 max-w-lg p-6 space-y-4">
            <h3 class="text-2xl font-bold text-red-400">!! System Error !!</h3>
            <p id="error-message" class="text-red-300"></p>
            <button onclick="hideModal('error-modal');" class="terminal-button bg-red-600 hover:bg-red-500">ACK</button>
        </div>
        <div id="success-modal" class="terminal-card bg-green-900/70 border-green-500 max-w-lg p-6 space-y-4 hidden">
            <h3 class="text-2xl font-bold text-green-400">âœ” Success</h3>
            <p id="success-message" class="text-green-200"></p>
            <button onclick="hideSuccess();" class="terminal-button bg-green-600 hover:bg-green-500">OK</button>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>